<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive Itinerary Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
/* Custom scrollbar */
    ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}
    ::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.1);
}
    ::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.3);
    border-radius: 10px;
}
    .dark ::-webkit-scrollbar-thumb {
    background-color: rgba(255,255,255,0.3);
}

/* Gradient backgrounds */
    .light-gradient {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}
    .dark-gradient {
    background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
}

/* Parallax effect */
    .parallax {
    background-attachment: fixed;
    background-position: center;
    background-repeat: no-repeat;
    background-size: cover;
}

/* Dragging styles */
    .dragging {
    opacity: 0.6 !important;
    transform: scale(1.05);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
}
    .drop-target {
    border-color: #3b82f6 !important;
    box-shadow: 0 0 10px #3b82f6;
}

/* Accessibility menu */
    #accessibilityMenu {
    transform: translateX(100%);
    transition: transform 0.3s ease;
}
    #accessibilityMenu.open {
        transform: translateX(0);
        }

        /* Line clamp for notes */
        .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        box-orient: vertical;
        -webkit-box-orient: vertical;
        overflow: hidden;
        }

        /* Responsive tweaks */
        @media (max-width: 640px) {
        #daysList {
        max-height: 200px !important;
        }
        #activitiesContainer {
        max-height: 300px !important;
        }
        }

        /* Focus styles for accessibility */
        *:focus-visible {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
        }
        </style>
        </head>
        <body class="light-gradient dark:dark-gradient text-gray-900 dark:text-gray-100 font-sans selection:bg-blue-400 selection:text-white transition-all duration-500 ease-in-out">
        <!-- Accessibility Menu Button -->
        <button id="accessibilityToggle" aria-label="Accessibility Options" class="fixed right-0 top-1/2 transform -translate-y-1/2 bg-blue-600 dark:bg-blue-800 text-white px-4 py-2 rounded-l-lg shadow-lg z-40">
        <i class="fas fa-universal-access text-xl"></i>
        </button>

        <!-- Accessibility Menu -->
        <div id="accessibilityMenu" class="fixed right-0 top-1/2 transform -translate-y-1/2 bg-white dark:bg-gray-800 shadow-lg rounded-l-lg p-4 z-30 w-64">
        <h3 class="text-lg font-bold mb-3">Accessibility Options</h3>
        <div class="space-y-3">
        <div>
        <label class="flex items-center space-x-2">
        <input type="checkbox" id="highContrast" class="rounded">
        <span>High Contrast</span>
        </label>
        </div>
        <div>
        <label class="flex items-center space-x-2">
        <input type="checkbox" id="largerText" class="rounded">
        <span>Larger Text</span>
        </label>
        </div>
        <div>
        <label class="flex items-center space-x-2">
        <input type="checkbox" id="dyslexicFont" class="rounded">
        <span>Dyslexic Font</span>
        </label>
        </div>
        <div>
        <label class="block mb-1">Text Size</label>
        <input type="range" id="textSize" min="12" max="24" value="16" class="w-full">
        </div>
        <button id="resetAccessibility" class="w-full bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded text-sm">
        Reset Settings
        </button>
        </div>
        </div>

        <div class="min-h-screen flex flex-col max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <header class="flex items-center justify-between py-6 border-b border-gray-300 dark:border-gray-700 flex-wrap gap-4">
        <h1 class="text-3xl font-extrabold tracking-tight flex-1 min-w-[200px]">Interactive Itinerary Board</h1>
        <div class="flex items-center space-x-2 flex-wrap justify-end gap-2 w-full sm:w-auto">
        <button id="toggleTheme" aria-label="Toggle Light/Dark Mode" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
        <i class="fas fa-moon text-xl" id="themeIcon"></i>
        </button>
        <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md shadow-md flex items-center space-x-1 transition-transform active:scale-95 whitespace-nowrap">
        <i class="fas fa-file-export"></i><span class="hidden sm:inline">Export (Mock)</span>
        </button>
        <button id="exportJsonBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md shadow-md flex items-center space-x-1 transition-transform active:scale-95 whitespace-nowrap">
        <i class="fas fa-file-download"></i><span class="hidden sm:inline">Export JSON</span>
        </button>
        <label for="importJsonInput" class="cursor-pointer bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded-md shadow-md flex items-center space-x-1 transition-transform active:scale-95 whitespace-nowrap">
        <i class="fas fa-file-upload"></i><span class="hidden sm:inline">Import JSON</span>
        </label>
        <input type="file" id="importJsonInput" accept="application/json" class="hidden" />
        <button id="shareLinkBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-md shadow-md flex items-center space-x-1 transition-transform active:scale-95 whitespace-nowrap">
        <i class="fas fa-link"></i><span class="hidden sm:inline">Copy Share Link</span>
        </button>
        </div>
        </header>

        <main class="flex flex-col md:flex-row flex-1 mt-6 gap-6 min-h-0">
        <!-- Days List & Controls -->
        <section class="md:w-72 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 flex flex-col min-h-0">
        <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Days</h2>
        <button id="addDayBtn" aria-label="Add Day" class="text-green-600 hover:text-green-800 transition-colors">
        <i class="fas fa-plus-circle fa-lg"></i>
        </button>
        </div>
        <ul id="daysList" class="flex flex-col space-y-2 overflow-y-auto scrollbar-thin max-h-[calc(100vh-280px)] min-h-0">
        <!-- Days inserted here dynamically -->
        </ul>
        <div class="mt-6 border-t border-gray-300 dark:border-gray-700 pt-4">
        <h3 class="text-lg font-semibold mb-2">Progress Summary</h3>
        <p id="totalActivities" class="mb-1">Total Activities: 0</p>
        <ul id="activityTypeCounts" class="list-disc list-inside space-y-1 text-sm text-gray-700 dark:text-gray-300 min-h-[4rem]">
        <!-- Counts by type -->
        </ul>
        </div>
        </section>

        <!-- Activities & Details -->
        <section class="flex-1 flex flex-col bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 min-w-0 min-h-0">
        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
        <h2 id="currentDayTitle" class="text-2xl font-semibold flex-1 min-w-[150px]">Select a Day</h2>
        <button id="addActivityBtn" aria-label="Add Activity" class="text-green-600 hover:text-green-800 disabled:opacity-50 disabled:cursor-not-allowed transition-colors whitespace-nowrap" disabled>
        <i class="fas fa-plus-circle fa-lg"></i>
        <span class="hidden sm:inline">Add Activity</span>
        </button>
        </div>
        <div id="activitiesContainer" class="flex-1 overflow-y-auto scrollbar-thin space-y-4 min-w-0 min-h-0 max-h-[calc(100vh-220px)]">
        <!-- Activities inserted here dynamically -->
        </div>
        </section>
        </main>

        <!-- Activity Edit Modal -->
        <div id="activityModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-lg w-full p-6 transform scale-90 transition-transform duration-300 relative max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-semibold mb-4" id="modalTitle">Edit Activity</h3>
        <form id="activityForm" class="space-y-4">
        <div>
        <label for="activityName" class="block font-medium mb-1">Activity Name <span class="text-red-500">*</span></label>
        <input type="text" id="activityName" name="name" required class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
        <label for="activityTime" class="block font-medium mb-1">Time</label>
        <input type="time" id="activityTime" name="time" class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
        <label for="activityType" class="block font-medium mb-1">Type</label>
        <select id="activityType" name="type" class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="sightseeing">Sightseeing</option>
        <option value="food">Food</option>
        <option value="transport">Transport</option>
        <option value="shopping">Shopping</option>
        <option value="other">Other</option>
        </select>
        </div>
        <div>
        <label for="activityTimeOfDay" class="block font-medium mb-1">Time of Day</label>
        <select id="activityTimeOfDay" name="timeofday" class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">-- Auto --</option>
        <option value="morning">Morning</option>
        <option value="afternoon">Afternoon</option>
        <option value="evening">Evening</option>
        </select>
        </div>
        </div>
        <div>
        <label for="activityLocation" class="block font-medium mb-1">Location</label>
        <input type="text" id="activityLocation" name="location" placeholder="E.g. Eiffel Tower, Paris" class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
        <label for="activityNotes" class="block font-medium mb-1">Notes</label>
        <textarea id="activityNotes" name="notes" rows="3" class="w-full rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 px-3 py-2 resize-y focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>
        <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700 flex-wrap gap-2">
        <button type="button" id="cancelActivityBtn" class="px-4 py-2 rounded-md bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors flex-1 sm:flex-none">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition-colors flex-1 sm:flex-none">Save</button>
        </div>
        </form>
        </div>
        </div>

        <!-- Export Mock Modal -->
        <div id="exportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-md w-full p-6 text-center max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-semibold mb-4">Export Itinerary</h3>
        <p class="mb-6">This is a mock export feature. In a real app, this would generate a PDF or image.</p>
        <button id="closeExportBtn" class="px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition-colors w-full sm:w-auto">Close</button>
        </div>
        </div>

        <!-- Toast for share link copied -->
        <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-md shadow-lg opacity-0 pointer-events-none transition-opacity duration-300 z-60 select-none max-w-xs text-center"></div>
        </div>

        <script>
        // Utility functions
        function generateId() {
        return '_' + Math.random().toString(36).substring(2, 9);
        }

        // Time of day auto-detection based on time string "HH:MM"
        function getTimeOfDay(time) {
        if (!time) return '';
        const [h, m] = time.split(':').map(Number);
        if (h < 12) return 'morning';
        if (h < 18) return 'afternoon';
        return 'evening';
        }

        // Color codes for activity types
        const typeColors = {
        sightseeing: 'bg-yellow-400 text-yellow-900',
        food: 'bg-red-400 text-red-900',
        transport: 'bg-blue-400 text-blue-900',
        shopping: 'bg-purple-400 text-purple-900',
        other: 'bg-gray-400 text-gray-900',
        };

        // Color codes for time of day
        const timeOfDayColors = {
        morning: 'bg-yellow-200',
        afternoon: 'bg-orange-200',
        evening: 'bg-purple-200',
        };

        // State
        let itinerary = [];
        let currentDayId = null;
        let draggedActivity = null;
        let draggedFromDayId = null;
        let draggedFromIndex = null;

        // DOM Elements
        const daysListEl = document.getElementById('daysList');
        const currentDayTitleEl = document.getElementById('currentDayTitle');
        const activitiesContainerEl = document.getElementById('activitiesContainer');
        const addDayBtn = document.getElementById('addDayBtn');
        const addActivityBtn = document.getElementById('addActivityBtn');
        const activityModal = document.getElementById('activityModal');
        const activityForm = document.getElementById('activityForm');
        const cancelActivityBtn = document.getElementById('cancelActivityBtn');
        const modalTitle = document.getElementById('modalTitle');
        const exportBtn = document.getElementById('exportBtn');
        const exportModal = document.getElementById('exportModal');
        const closeExportBtn = document.getElementById('closeExportBtn');
        const toggleThemeBtn = document.getElementById('toggleTheme');
        const themeIcon = document.getElementById('themeIcon');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const importJsonInput = document.getElementById('importJsonInput');
        const shareLinkBtn = document.getElementById('shareLinkBtn');
        const totalActivitiesEl = document.getElementById('totalActivities');
        const activityTypeCountsEl = document.getElementById('activityTypeCounts');
        const toastEl = document.getElementById('toast');
        const accessibilityToggle = document.getElementById('accessibilityToggle');
        const accessibilityMenu = document.getElementById('accessibilityMenu');
        const highContrastToggle = document.getElementById('highContrast');
        const largerTextToggle = document.getElementById('largerText');
        const dyslexicFontToggle = document.getElementById('dyslexicFont');
        const textSizeSlider = document.getElementById('textSize');
        const resetAccessibilityBtn = document.getElementById('resetAccessibility');

        // Load from URL hash or localStorage
        function loadItinerary() {
        const hash = window.location.hash.slice(1);
        if (hash) {
        try {
        const decoded = decodeURIComponent(hash);
        const parsed = JSON.parse(decoded);
        if (Array.isArray(parsed)) {
        itinerary = parsed;
        if (itinerary.length > 0) {
        currentDayId = itinerary[0].id;
        }
        saveItinerary(); // Save to localStorage for fallback
        return;
        }
        } catch {
        // ignore errors, fallback to localStorage
        }
        }
        const data = localStorage.getItem('itineraryData');
        if (data) {
        try {
        itinerary = JSON.parse(data);
        if (itinerary.length > 0) {
        currentDayId = itinerary[0].id;
        }
        } catch {
        itinerary = [];
        currentDayId = null;
        }
        }
        }

        // Save to localStorage
        function saveItinerary() {
        localStorage.setItem('itineraryData', JSON.stringify(itinerary));
        }

        // Render days list with icon
        function renderDays() {
        daysListEl.innerHTML = '';
        itinerary.forEach((day, index) => {
        const li = document.createElement('li');
        li.className = `flex items-center justify-between p-2 rounded-md cursor-pointer select-none transition-colors ${
        day.id === currentDayId
        ? 'bg-blue-600 text-white shadow-md'
        : 'hover:bg-blue-100 dark:hover:bg-blue-700'
        }`;
        li.setAttribute('data-day-id', day.id);
        li.setAttribute('tabindex', '0');
        li.setAttribute('role', 'button');
        li.setAttribute('aria-pressed', day.id === currentDayId ? 'true' : 'false');

        // Container for icon and text
        const container = document.createElement('div');
        container.className = 'flex items-center space-x-2 flex-1 min-w-0';

        // Icon for day
        const icon = document.createElement('i');
        icon.className = 'fas fa-calendar-day flex-shrink-0 text-lg';
        container.appendChild(icon);

        // Text label
        const text = document.createElement('span');
        text.className = 'truncate';
        text.textContent = `Day ${index + 1}`;
        container.appendChild(text);

        li.appendChild(container);

        // Delete day button
        const delBtn = document.createElement('button');
        delBtn.className = 'ml-2 text-red-600 hover:text-red-800 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 flex-shrink-0';
        delBtn.setAttribute('aria-label', `Delete Day ${index + 1}`);
        delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm(`Delete Day ${index + 1}? This will remove all its activities.`)) {
        deleteDay(day.id);
        }
        });

        li.appendChild(delBtn);

        li.addEventListener('click', () => {
        if (currentDayId !== day.id) {
        switchDay(day.id);
        }
        });
        li.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (currentDayId !== day.id) {
        switchDay(day.id);
        }
        }
        });

        daysListEl.appendChild(li);
        });
        renderProgressSummary();
        }

        // Switch current day
        function switchDay(dayId) {
        currentDayId = dayId;
        renderDays();
        renderActivities();
        }

        // Delete day
        function deleteDay(dayId) {
        itinerary = itinerary.filter((d) => d.id !== dayId);
        if (currentDayId === dayId) {
        currentDayId = itinerary.length > 0 ? itinerary[0].id : null;
        }
        saveItinerary();
        renderDays();
        renderActivities();
        updateAddActivityBtn();
        }

        // Render activities for current day
        function renderActivities() {
        activitiesContainerEl.innerHTML = '';
        if (!currentDayId) {
        currentDayTitleEl.textContent = 'Select a Day';
        addActivityBtn.disabled = true;
        return;
        }
        const day = itinerary.find((d) => d.id === currentDayId);
        if (!day) {
        currentDayTitleEl.textContent = 'Select a Day';
        addActivityBtn.disabled = true;
        return;
        }
        currentDayTitleEl.textContent = `Day ${itinerary.indexOf(day) + 1} Activities`;

        addActivityBtn.disabled = false;

        // Sort activities by time ascending (empty time last)
        day.activities.sort((a, b) => {
        if (!a.time && !b.time) return 0;
        if (!a.time) return 1;
        if (!b.time) return -1;
        return a.time.localeCompare(b.time);
        });

        day.activities.forEach((activity, index) => {
        const card = createActivityCard(activity, day.id, index);
        activitiesContainerEl.appendChild(card);
        });
        }

        // Create activity card element
        function createActivityCard(activity, dayId, index) {
        const card = document.createElement('div');
        card.className =
        'bg-gray-100 dark:bg-gray-700 rounded-lg p-4 shadow-md cursor-grab select-none flex flex-col space-y-2 transition-transform duration-200 ease-in-out';
        card.setAttribute('draggable', 'true');
        card.setAttribute('data-activity-id', activity.id);
        card.setAttribute('data-day-id', dayId);
        card.setAttribute('tabindex', '0');
        card.setAttribute('role', 'listitem');
        card.style.willChange = 'transform, box-shadow';

        // Drag events
        card.addEventListener('dragstart', (e) => {
        draggedActivity = activity;
        draggedFromDayId = dayId;
        draggedFromIndex = index;
        card.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        // Firefox requires dataTransfer data to be set
        e.dataTransfer.setData('text/plain', activity.id);
        setTimeout(() => {
        card.style.display = 'none';
        }, 0);
        });
        card.addEventListener('dragend', (e) => {
        draggedActivity = null;
        draggedFromDayId = null;
        draggedFromIndex = null;
        card.classList.remove('dragging');
        card.style.display = '';
        clearDropTargets();
        });

        // Keyboard accessibility: open edit modal on Enter or Space
        card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openEditActivityModal(dayId, activity.id);
        }
        });

        // Content layout
        const topRow = document.createElement('div');
        topRow.className = 'flex justify-between items-center flex-wrap gap-2';

        // Activity name
        const nameEl = document.createElement('h3');
        nameEl.className = 'font-semibold text-lg truncate flex-1 min-w-0';
        nameEl.textContent = activity.name || 'Unnamed Activity';

        // Time badge with visual indicator
        const timeOfDay = activity.timeofday || getTimeOfDay(activity.time);
        const timeBadge = document.createElement('span');
        timeBadge.className = `text-xs font-semibold px-2 py-0.5 rounded-full ${
        timeOfDayColors[timeOfDay] || 'bg-gray-300 dark:bg-gray-600'
        }`;
        timeBadge.textContent = activity.time || (timeOfDay ? timeOfDay.charAt(0).toUpperCase() + timeOfDay.slice(1) : 'No time');

        topRow.appendChild(nameEl);
        topRow.appendChild(timeBadge);

        // Type tag
        const typeTag = document.createElement('span');
        typeTag.className = `inline-block mt-1 text-xs font-semibold px-2 py-0.5 rounded-full ${
        typeColors[activity.type] || typeColors.other
        }`;
        typeTag.textContent = activity.type ? activity.type.charAt(0).toUpperCase() + activity.type.slice(1) : 'Other';

        // Location and notes container
        const locNotesContainer = document.createElement('div');
        locNotesContainer.className = 'flex flex-col space-y-1';

        // Location with Map button if location present
        if (activity.location) {
        const locRow = document.createElement('div');
        locRow.className = 'flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-300 truncate';

        const locationEl = document.createElement('p');
        locationEl.className = 'truncate flex-1';
        locationEl.textContent = activity.location;

        const mapBtn = document.createElement('button');
        mapBtn.className = 'text-blue-600 hover:text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1';
        mapBtn.setAttribute('aria-label', `Open map for ${activity.location}`);
        mapBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
        mapBtn.addEventListener('click', () => {
        const query = encodeURIComponent(activity.location);
        window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank', 'noopener');
        });

        locRow.appendChild(locationEl);
        locRow.appendChild(mapBtn);
        locNotesContainer.appendChild(locRow);
        }

        // Notes
        if (activity.notes) {
        const notesEl = document.createElement('p');
        notesEl.className = 'text-sm text-gray-500 dark:text-gray-400 italic line-clamp-2';
        notesEl.textContent = activity.notes;
        locNotesContainer.appendChild(notesEl);
        }

        // Buttons row
        const btnRow = document.createElement('div');
        btnRow.className = 'flex justify-end space-x-2 mt-2 flex-wrap gap-1';

        // Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'text-blue-600 hover:text-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-1 flex items-center gap-1';
        editBtn.setAttribute('aria-label', `Edit activity ${activity.name}`);
        editBtn.innerHTML = '<i class="fas fa-edit"></i><span class="sr-only">Edit</span>';
        editBtn.addEventListener('click', () => openEditActivityModal(dayId, activity.id));

        // Delete button
        const delBtn = document.createElement('button');
        delBtn.className = 'text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 rounded-md p-1 flex items-center gap-1';
        delBtn.setAttribute('aria-label', `Delete activity ${activity.name}`);
        delBtn.innerHTML = '<i class="fas fa-trash-alt"></i><span class="sr-only">Delete</span>';
        delBtn.addEventListener('click', () => {
        if (confirm(`Delete activity "${activity.name}"?`)) {
        deleteActivity(dayId, activity.id);
        }
        });

        btnRow.appendChild(editBtn);
        btnRow.appendChild(delBtn);

        card.appendChild(topRow);
        card.appendChild(typeTag);
        if (locNotesContainer.children.length) card.appendChild(locNotesContainer);
        card.appendChild(btnRow);

        // Dragover and drop events for reordering and moving between days
        card.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (!draggedActivity) return;
        if (draggedActivity.id === activity.id) return;
        if (card.classList.contains('drop-target')) return;
        clearDropTargets();
        card.classList.add('drop-target');
        });
        card.addEventListener('dragleave', (e) => {
        card.classList.remove('drop-target');
        });
        card.addEventListener('drop', (e) => {
        e.preventDefault();
        card.classList.remove('drop-target');
        if (!draggedActivity) return;
        if (draggedActivity.id === activity.id) return;

        // Remove dragged activity from old day
        const fromDay = itinerary.find((d) => d.id === draggedFromDayId);
        if (!fromDay) return;
        const draggedIndex = fromDay.activities.findIndex((a) => a.id === draggedActivity.id);
        if (draggedIndex === -1) return;
        fromDay.activities.splice(draggedIndex, 1);

        // Insert into new day at this activity's position
        const toDay = itinerary.find((d) => d.id === dayId);
        if (!toDay) return;
        const toIndex = toDay.activities.findIndex((a) => a.id === activity.id);
        if (toIndex === -1) return;
        toDay.activities.splice(toIndex, 0, draggedActivity);

        saveItinerary();
        renderActivities();
        if (draggedFromDayId !== dayId) {
        renderDays();
        }
        });

        return card;
        }

        // Clear all drop target highlights
        function clearDropTargets() {
        document.querySelectorAll('.drop-target').forEach((el) => el.classList.remove('drop-target'));
        }

        // Add new day
        function addDay() {
        const newDay = {
        id: generateId(),
        activities: [],
        };
        itinerary.push(newDay);
        currentDayId = newDay.id;
        saveItinerary();
        renderDays();
        renderActivities();
        updateAddActivityBtn();
        }

        // Add new activity
        function addActivity() {
        if (!currentDayId) return;
        openEditActivityModal(currentDayId, null);
        }

        // Delete activity
        function deleteActivity(dayId, activityId) {
        const day = itinerary.find((d) => d.id === dayId);
        if (!day) return;
        day.activities = day.activities.filter((a) => a.id !== activityId);
        saveItinerary();
        renderActivities();
        renderProgressSummary();
        }

        // Open modal to edit or add activity
        function openEditActivityModal(dayId, activityId) {
        activityModal.classList.remove('opacity-0', 'pointer-events-none');
        setTimeout(() => {
        activityModal.querySelector('div').classList.remove('scale-90');
        }, 10);

        modalTitle.textContent = activityId ? 'Edit Activity' : 'Add Activity';

        // Reset form
        activityForm.reset();
        activityForm.dataset.dayId = dayId;
        activityForm.dataset.activityId = activityId || '';

        if (activityId) {
        const day = itinerary.find((d) => d.id === dayId);
        if (!day) return;
        const activity = day.activities.find((a) => a.id === activityId);
        if (!activity) return;
        activityForm.activityName.value = activity.name || '';
        activityForm.activityTime.value = activity.time || '';
        activityForm.activityType.value = activity.type || 'other';
        activityForm.activityLocation.value = activity.location || '';
        activityForm.activityNotes.value = activity.notes || '';
        activityForm.activityTimeOfDay.value = activity.timeofday || '';
        } else {
        activityForm.activityType.value = 'other';
        activityForm.activityTimeOfDay.value = '';
        }

        activityForm.activityName.focus();
        }

        // Close activity modal
        function closeActivityModal() {
        activityModal.querySelector('div').classList.add('scale-90');
        setTimeout(() => {
        activityModal.classList.add('opacity-0', 'pointer-events-none');
        }, 200);
        }

        // Save activity from modal form
        function saveActivityFromForm(e) {
        e.preventDefault();
        const dayId = activityForm.dataset.dayId;
        const activityId = activityForm.dataset.activityId;
        const day = itinerary.find((d) => d.id === dayId);
        if (!day) return;

        const name = activityForm.activityName.value.trim();
        if (!name) {
        alert('Activity name is required.');
        return;
        }
        const time = activityForm.activityTime.value;
        const type = activityForm.activityType.value;
        const location = activityForm.activityLocation.value.trim();
        const notes = activityForm.activityNotes.value.trim();
        const timeofday = activityForm.activityTimeOfDay.value;

        if (activityId) {
        // Edit existing
        const activity = day.activities.find((a) => a.id === activityId);
        if (!activity) return;
        activity.name = name;
        activity.time = time;
        activity.type = type;
        activity.location = location;
        activity.notes = notes;
        activity.timeofday = timeofday;
        } else {
        // Add new
        const newActivity = {
        id: generateId(),
        name,
        time,
        type,
        location,
        notes,
        timeofday,
        };
        day.activities.push(newActivity);
        }
        saveItinerary();
        renderActivities();
        renderProgressSummary();
        closeActivityModal();
        }

        // Update add activity button disabled state
        function updateAddActivityBtn() {
        addActivityBtn.disabled = !currentDayId;
        }

        // Export mock
        function openExportModal() {
        exportModal.classList.remove('opacity-0', 'pointer-events-none');
        }
        function closeExportModal() {
        exportModal.classList.add('opacity-0', 'pointer-events-none');
        }

        // Light/Dark mode toggle
        function loadTheme() {
        const saved = localStorage.getItem('theme');
        if (saved === 'dark') {
        document.documentElement.classList.add('dark');
        themeIcon.className = 'fas fa-sun text-yellow-400 text-xl';
        } else {
        document.documentElement.classList.remove('dark');
        themeIcon.className = 'fas fa-moon text-xl';
        }
        }
        function toggleTheme() {
        if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        themeIcon.className = 'fas fa-moon text-xl';
        } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        themeIcon.className = 'fas fa-sun text-yellow-400 text-xl';
        }
        }

        // Accessibility menu toggle
        function toggleAccessibilityMenu() {
        accessibilityMenu.classList.toggle('open');
        }

        // Apply high contrast mode
        function applyHighContrast() {
        if (highContrastToggle.checked) {
        document.body.classList.add('high-contrast');
        document.body.classList.remove('light-gradient', 'dark-gradient');
        document.body.style.backgroundColor = '#000';
        document.body.style.color = '#fff';
        } else {
        document.body.classList.remove('high-contrast');
        document.body.classList.add(document.documentElement.classList.contains('dark') ? 'dark-gradient' : 'light-gradient');
        document.body.style.backgroundColor = '';
        document.body.style.color = '';
        }
        }

        // Apply larger text
        function applyLargerText() {
        if (largerTextToggle.checked) {
        document.body.style.fontSize = '1.2rem';
        } else {
        document.body.style.fontSize = '';
        }
        }

        // Apply dyslexic font
        function applyDyslexicFont() {
        if (dyslexicFontToggle.checked) {
        document.body.style.fontFamily = 'Comic Sans MS, sans-serif';
        } else {
        document.body.style.fontFamily = '';
        }
        }

        // Apply text size
        function applyTextSize() {
        const size = textSizeSlider.value;
        document.body.style.fontSize = `${size}px`;
        }

        // Reset accessibility settings
        function resetAccessibility() {
        highContrastToggle.checked = false;
        largerTextToggle.checked = false;
        dyslexicFontToggle.checked = false;
        textSizeSlider.value = 16;
        document.body.classList.remove('high-contrast');
        document.body.style.fontSize = '';
        document.body.style.fontFamily = '';
        document.body.classList.add(document.documentElement.classList.contains('dark') ? 'dark-gradient' : 'light-gradient');
        }

        // Drag and drop on activities container for dropping at end of list
        activitiesContainerEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (!draggedActivity) return;
        clearDropTargets();
        activitiesContainerEl.classList.add('drop-target');
        });
        activitiesContainerEl.addEventListener('dragleave', (e) => {
        activitiesContainerEl.classList.remove('drop-target');
        });
        activitiesContainerEl.addEventListener('drop', (e) => {
        e.preventDefault();
        activitiesContainerEl.classList.remove('drop-target');
        if (!draggedActivity) return;

        // Remove from old day
        const fromDay = itinerary.find((d) => d.id === draggedFromDayId);
        if (!fromDay) return;
        const draggedIndex = fromDay.activities.findIndex((a) => a.id === draggedActivity.id);
        if (draggedIndex === -1) return;
        fromDay.activities.splice(draggedIndex, 1);

        // Add to end of current day
        const toDay = itinerary.find((d) => d.id === currentDayId);
        if (!toDay) return;
        toDay.activities.push(draggedActivity);

        saveItinerary();
        renderActivities();
        if (draggedFromDayId !== currentDayId) {
        renderDays();
        }
        });

        // Keyboard shortcut: Ctrl+N to add day, Ctrl+A to add activity
        window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && !e.shiftKey && !e.altKey) {
        if (e.key.toLowerCase() === 'n') {
        e.preventDefault();
        addDay();
        }
        if (e.key.toLowerCase() === 'a') {
        e.preventDefault();
        if (!addActivityBtn.disabled) addActivity();
        }
        }
        });

        // Accessibility: close modals on Escape
        window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
        if (!activityModal.classList.contains('opacity-0')) {
        closeActivityModal();
        }
        if (!exportModal.classList.contains('opacity-0')) {
        closeExportModal();
        }
        if (accessibilityMenu.classList.contains('open')) {
        toggleAccessibilityMenu();
        }
        }
        });

        // JSON Export
        function exportJson() {
        if (!itinerary.length) {
        alert('No itinerary data to export.');
        return;
        }
        const dataStr = JSON.stringify(itinerary, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'itinerary.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        }

        // JSON Import
        function importJson(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
        try {
        const imported = JSON.parse(e.target.result);
        if (!Array.isArray(imported)) throw new Error('Invalid format');
        // Validate minimal structure
        if (!imported.every(d => d.id && Array.isArray(d.activities))) throw new Error('Invalid structure');
        itinerary = imported;
        currentDayId = itinerary.length > 0 ? itinerary[0].id : null;
        saveItinerary();
        renderDays();
        renderActivities();
        updateAddActivityBtn();
        renderProgressSummary();
        alert('Itinerary imported successfully.');
        } catch (err) {
        alert('Failed to import JSON: ' + err.message);
        }
        };
        reader.readAsText(file);
        }

        // Shareable link generation
        function copyShareLink() {
        if (!itinerary.length) {
        alert('No itinerary data to share.');
        return;
        }
        try {
        const jsonStr = JSON.stringify(itinerary);
        const encoded = encodeURIComponent(jsonStr);
        const url = `${window.location.origin}${window.location.pathname}#${encoded}`;
        navigator.clipboard.writeText(url).then(() => {
        showToast('Share link copied to clipboard!');
        }, () => {
        alert('Failed to copy share link.');
        });
        } catch {
        alert('Failed to generate share link.');
        }
        }

        // Toast message
        let toastTimeout = null;
        function showToast(message) {
        toastEl.textContent = message;
        toastEl.classList.remove('opacity-0', 'pointer-events-none');
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
        toastEl.classList.add('opacity-0', 'pointer-events-none');
        }, 3000);
        }

        // Render progress summary in sidebar
        function renderProgressSummary() {
        let total = 0;
        const counts = {};
        itinerary.forEach(day => {
        day.activities.forEach(act => {
        total++;
        const t = act.type || 'other';
        counts[t] = (counts[t] || 0) + 1;
        });
        });
        totalActivitiesEl.textContent = `Total Activities: ${total}`;
        activityTypeCountsEl.innerHTML = '';
        const keys = Object.keys(typeColors);
        keys.forEach(type => {
        const count = counts[type] || 0;
        if (count > 0) {
        const li = document.createElement('li');
        li.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)}: ${count}`;
        activityTypeCountsEl.appendChild(li);
        }
        });
        if (Object.keys(counts).length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No activities yet';
        activityTypeCountsEl.appendChild(li);
        }
        }

        // Initialization
        loadItinerary();
        renderDays();
        renderActivities();
        updateAddActivityBtn();
        renderProgressSummary();
        loadTheme();

        // Event listeners
        addDayBtn.addEventListener('click', addDay);
        addActivityBtn.addEventListener('click', addActivity);
        cancelActivityBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closeActivityModal();
        });
        activityForm.addEventListener('submit', saveActivityFromForm);
        exportBtn.addEventListener('click', openExportModal);
        closeExportBtn.addEventListener('click', closeExportModal);
        toggleThemeBtn.addEventListener('click', toggleTheme);
        exportJsonBtn.addEventListener('click', exportJson);
        importJsonInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
        importJson(e.target.files[0]);
        e.target.value = '';
        }
        });
        shareLinkBtn.addEventListener('click', copyShareLink);
        accessibilityToggle.addEventListener('click', toggleAccessibilityMenu);
        highContrastToggle.addEventListener('change', applyHighContrast);
        largerTextToggle.addEventListener('change', applyLargerText);
        dyslexicFontToggle.addEventListener('change', applyDyslexicFont);
        textSizeSlider.addEventListener('input', applyTextSize);
        resetAccessibilityBtn.addEventListener('click', resetAccessibility);

        // Parallax effect on scroll
        window.addEventListener('scroll', function() {
        const scrollPosition = window.pageYOffset;
        document.body.style.backgroundPosition = `center ${scrollPosition * 0.5}px`;
        });
        </script>
        </body>
        </html>